{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///D:/ELECTION/SiteRAG/presiapp/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = global as unknown as { prisma: PrismaClient }\n\nexport const prisma =\n  globalForPrisma.prisma ||\n  new PrismaClient({\n    log: ['query'],\n  })\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AAEC,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK;QAAC;KAAQ;AAChB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 69, "column": 0}, "map": {"version":3,"sources":["file:///D:/ELECTION/SiteRAG/presiapp/app/api/stats/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport type { Candidat, Resultat } from \"@prisma/client\"\r\n\r\ntype CandidatWithResults = Candidat & {\r\n  resultats: Resultat[]\r\n}\r\n\r\nexport async function GET(req: Request) {\r\n  try {\r\n    const { searchParams } = new URL(req.url)\r\n    const wilayaId = searchParams.get(\"wilayaId\")\r\n    const moughataaId = searchParams.get(\"moughataaId\")\r\n    const communeId = searchParams.get(\"communeId\")\r\n    const centreId = searchParams.get(\"centreId\")\r\n    const bureauId = searchParams.get(\"bureauId\")\r\n\r\n    // Construire le filtre dynamique\r\n    let whereBureau: any = {}\r\n    if (bureauId) whereBureau.id = Number(bureauId)\r\n    else if (centreId) whereBureau.centreId = Number(centreId)\r\n    else if (communeId)\r\n      whereBureau.centre = { communeId: Number(communeId) }\r\n    else if (moughataaId)\r\n      whereBureau.centre = { commune: { moughataaId: Number(moughataaId) } }\r\n    else if (wilayaId)\r\n      whereBureau.centre = { commune: { moughataa: { wilayaId: Number(wilayaId) } } }\r\n\r\n    // Récupération des bureaux filtrés avec tous leurs résultats\r\n    const bureaux = await prisma.bureau.findMany({\r\n      where: whereBureau,\r\n      include: {\r\n        resultats: { include: { candidat: true } },\r\n      },\r\n    })\r\n\r\n    // --- Cas sans filtres : statistiques globales ---\r\n    if (bureaux.length === 0 && !wilayaId && !moughataaId && !communeId && !centreId && !bureauId) {\r\n      const [\r\n        totalWilayas,\r\n        totalBureaux,\r\n        totalCandidats,\r\n        totalInscritsAgg,\r\n        totalVotantsAgg,\r\n        totalVoixAgg,\r\n      ] = await Promise.all([\r\n        prisma.wilaya.count(),\r\n        prisma.bureau.count(),\r\n        prisma.candidat.count({ where: { actif: true } }),\r\n        prisma.bureau.aggregate({ _sum: { nombreInscrits: true } }),\r\n        prisma.bureau.aggregate({ _sum: { nombreVotants: true } }),\r\n        prisma.resultat.aggregate({ _sum: { nombreVoix: true } }),\r\n      ])\r\n\r\n      const bureauxDepouilles = await prisma.bureau.count({\r\n        where: { resultats: { some: {} } },\r\n      })\r\n\r\n      const totalInscrits = totalInscritsAgg._sum.nombreInscrits || 0\r\n      const totalVotants = totalVotantsAgg._sum.nombreVotants || 0\r\n      const totalVoix = totalVoixAgg._sum.nombreVoix || 0\r\n\r\n      const participationRate = totalInscrits\r\n        ? (totalVotants / totalInscrits) * 100\r\n        : 0\r\n\r\n      const pourcentageDepouilles =\r\n        totalBureaux > 0 ? (bureauxDepouilles / totalBureaux) * 100 : 0\r\n\r\n      // Résultats par candidat\r\n      const candidatsResults = await prisma.candidat.findMany({\r\n        where: { actif: true },\r\n        include: { resultats: true },\r\n      })\r\n\r\n      const candidatsWithVotes = (candidatsResults as CandidatWithResults[])\r\n        .map((candidat) => {\r\n          const totalVoixCandidat = candidat.resultats.reduce(\r\n            (sum, r) => sum + (r.nombreVoix || 0),\r\n            0\r\n          )\r\n          return {\r\n            id: candidat.id,\r\n            nom_fr: candidat.nom_fr,\r\n            nom_ar: candidat.nom_ar,\r\n            photo: candidat.photo,\r\n            logo: candidat.logo,\r\n            couleur: candidat.couleur,\r\n            totalVoix: totalVoixCandidat,\r\n          }\r\n        })\r\n        .sort((a, b) => b.totalVoix - a.totalVoix)\r\n\r\n      const totalVoixGlobal = candidatsWithVotes.reduce(\r\n        (sum, c) => sum + c.totalVoix,\r\n        0\r\n      )\r\n\r\n      const candidatsWithPercentages = candidatsWithVotes.map((c) => ({\r\n        ...c,\r\n        pourcentage: totalVoixGlobal\r\n          ? (c.totalVoix / totalVoixGlobal) * 100\r\n          : 0,\r\n      }))\r\n\r\n      // ✅ Calcul des votes nuls/rejetés : un seul résultat par bureau\r\n      const bureauxAvecResultat = await prisma.bureau.findMany({\r\n        include: { resultats: true },\r\n      })\r\n\r\n      let totalNuls = 0\r\n      let totalRejetes = 0\r\n\r\n      for (const b of bureauxAvecResultat) {\r\n        if (b.resultats.length > 0) {\r\n          totalNuls += b.resultats[0].voixNuls || 0\r\n          totalRejetes += b.resultats[0].voixRejetes || 0\r\n        }\r\n      }\r\n\r\n      return NextResponse.json({\r\n        globalStats: {\r\n          totalWilayas,\r\n          totalBureaux,\r\n          totalCandidats,\r\n          totalInscrits,\r\n          totalVotants,\r\n          totalVoix,\r\n          totalNuls,\r\n          totalRejetes,\r\n          bureauxDepouilles,\r\n          pourcentageDepouilles: Math.round(pourcentageDepouilles * 100) / 100,\r\n          participationRate: Math.round(participationRate * 100) / 100,\r\n        },\r\n        candidatsResults: candidatsWithPercentages,\r\n      })\r\n    }\r\n\r\n    // --- Cas filtré ---\r\n    let totalInscrits = 0\r\n    let totalVotants = 0\r\n    let totalNuls = 0\r\n    let totalRejetes = 0\r\n    let totalBureaux = bureaux.length\r\n    let bureauxDepouilles = 0\r\n    const candidatsMap: Record<number, any> = {}\r\n\r\n    for (const bureau of bureaux) {\r\n      totalInscrits += bureau.nombreInscrits || 0\r\n      totalVotants += bureau.nombreVotants || 0\r\n      if (bureau.resultats.length > 0) bureauxDepouilles++\r\n\r\n      // ✅ Nuls/Rejetés : prendre seulement le premier résultat du bureau\r\n      if (bureau.resultats.length > 0) {\r\n        totalNuls += bureau.resultats[0].voixNuls || 0\r\n        totalRejetes += bureau.resultats[0].voixRejetes || 0\r\n      }\r\n\r\n      // Résultats des candidats\r\n      for (const r of bureau.resultats) {\r\n        if (!candidatsMap[r.candidat.id]) {\r\n          candidatsMap[r.candidat.id] = {\r\n            id: r.candidat.id,\r\n            nom_fr: r.candidat.nom_fr,\r\n            nom_ar: r.candidat.nom_ar,\r\n            photo: r.candidat.photo,\r\n            logo: r.candidat.logo,\r\n            couleur: r.candidat.couleur,\r\n            totalVoix: 0,\r\n          }\r\n        }\r\n        candidatsMap[r.candidat.id].totalVoix += r.nombreVoix || 0\r\n      }\r\n    }\r\n\r\n    const totalVoix = Object.values(candidatsMap).reduce(\r\n      (sum, c: any) => sum + c.totalVoix,\r\n      0\r\n    )\r\n\r\n    const candidatsResults = Object.values(candidatsMap).map((c: any) => ({\r\n      ...c,\r\n      pourcentage: totalVoix > 0 ? (c.totalVoix / totalVoix) * 100 : 0,\r\n    }))\r\n\r\n    const totalCandidats = await prisma.candidat.count({ where: { actif: true } })\r\n\r\n    const globalStats = {\r\n      totalBureaux,\r\n      bureauxDepouilles,\r\n      pourcentageDepouilles:\r\n        totalBureaux > 0\r\n          ? Math.round((bureauxDepouilles / totalBureaux) * 100)\r\n          : 0,\r\n      totalInscrits,\r\n      totalVotants,\r\n      totalVoix,\r\n      totalNuls,\r\n      totalRejetes,\r\n      participationRate:\r\n        totalInscrits > 0\r\n          ? Math.round((totalVotants / totalInscrits) * 100)\r\n          : 0,\r\n      totalCandidats,\r\n    }\r\n\r\n    return NextResponse.json({ globalStats, candidatsResults })\r\n  } catch (error) {\r\n    console.error(\"Erreur lors du calcul des statistiques:\", error)\r\n    return NextResponse.json(\r\n      { error: \"Erreur lors du calcul des statistiques\" },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}